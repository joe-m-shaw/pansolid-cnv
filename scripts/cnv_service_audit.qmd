---
title: "PanSolidv2 CNV Audit"
author: "Joe Shaw, Clinical Scientist (CS20980)"
date: today
date-format: "DD/MM/YYYY"
format: html
editor: visual
---

```{r}
#| label: packages
#| include: FALSE

library(tidyverse)
library(readxl)
library(here)

```

```{r}
#| label: functions
#| include: FALSE

source(here::here("functions/cnv_functions.R"))

```

```{r}
#| label: read-data
#| include: FALSE

fold_change_threshold <- 2.8

# Manually add new worksheets to this Excel
pansolid_worksheets <- read_excel(here::here("data/pansolid_live_service_worksheets.xlsx"))

# Previously collated data
pansolid_cnv_collated_data <- read_csv(here::here("data/pansolid_v2_cnv_service_results.csv"))

new_pansolid_worksheets <- pansolid_worksheets |> 
  filter(!worksheet %in% pansolid_cnv_collated_data$worksheet)

live_worksheets <- list(new_pansolid_worksheets$worksheet)

live_ws_filepaths <- live_worksheets |> 
  map(\(live_worksheets) get_annotated_filepaths(live_worksheets)) |> 
  flatten()

new_ws_amp_gene_results <- live_ws_filepaths |> 
  map(\(live_ws_filepaths) read_annotated_file_all_amp(live_ws_filepaths)) |>
  list_rbind()

new_ws_stdev_results <- live_ws_filepaths |> 
  map(\(live_ws_filepaths) read_annotated_file_stdev(live_ws_filepaths)) |>
  list_rbind()

if (nrow(new_ws_amp_gene_results) == 0 &
    nrow(new_ws_stdev_results) == 0) {
  
  rm(new_ws_amp_gene_results)
  rm(new_ws_stdev_results)
  
  } else {
    
    new_pansolid_data <- new_ws_amp_gene_results |> 
      left_join(new_ws_stdev_results |> 
              select(file, st_dev_signal_adjusted_log2_ratios), 
              by = "file") |> 
      select(-c("x4", "x5", "x6", "x7", "x8"))
    
    pansolid_cnv_collated_data <- rbind(new_pansolid_data,
                                   pansolid_cnv_collated_data)
    
    write.csv(pansolid_cnv_collated_data,
              here::here("data/pansolid_v2_cnv_service_results.csv"),
              row.names = FALSE)
    
  }

```

In total, `r length(unique(pansolid_cnv_collated_data$labno))` samples have been tested by PanSolidv2 CNV analysis.

```{r}
#| label: check-amplifications
#| include: FALSE

live_results_mod <- pansolid_cnv_collated_data |> 
  mutate(result = case_when(
    
    max_region_fold_change >= fold_change_threshold ~"Amplification detected",
    
    max_region_fold_change < fold_change_threshold ~"No amplification detected"))

```

Here's the summary of amplifications detected for samples passing the quality filter (signal-adjusted noise metric below 1).

```{r}
#| label: summary-gene-amps-filter
#| echo: FALSE

summary_table_filter <- live_results_mod |> 
  filter(st_dev_signal_adjusted_log2_ratios < 1) |> 
  group_by(gene, result) |> 
  count() |> 
  pivot_wider(names_from = result, values_from = n, values_fill = 0)

knitr::kable(summary_table_filter)

```

These are the samples with amplifications detected.

```{r}
#| label: view-amps
#| echo: FALSE

new_regex <- regex(
  r"[
  .+
  (WS\d{6}/.+.xlsx)
  ]",
  comments = TRUE
)

amps_detected <- live_results_mod |> 
  mutate(filepath_edit = str_extract(
    string = live_results_mod$file, 
    pattern = new_regex, group = 1)) |> 
  filter(st_dev_signal_adjusted_log2_ratios < 1 &
           result == "Amplification detected") |> 
  select(filepath_edit, gene, max_region_fold_change, 
         st_dev_signal_adjusted_log2_ratios)

knitr::kable(amps_detected)

```

{{< pagebreak >}}

And here's the overall view of gene fold changes.

```{r}
#| label: amps-plots
#| echo: FALSE

gene_fold_changes_plot <- ggplot(live_results_mod |> 
                                   filter(st_dev_signal_adjusted_log2_ratios < 1), 
                                 aes(x = gene, y = max_region_fold_change)) +
  geom_jitter(pch = 21, width = 0.2, alpha = 0.5, aes(fill = result)) +
  scale_fill_manual(values = c(safe_red, safe_blue)) +
  theme_bw() +
  labs(x = "", y = "Maximum region fold change") +
  geom_hline(yintercept = fold_change_threshold, linetype = "dashed")

gene_fold_changes_plot

```
